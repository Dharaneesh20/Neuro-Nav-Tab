{% extends "base.html" %}
{% block title %}Panic Mode - Neuro-Nav{% endblock %}
{% block content %}
<div class="min-h-screen flex items-center justify-center px-4 bg-gradient-to-br from-danger-rose via-secondary-pink to-accent-purple"
     style="box-shadow: inset 0 0 100px rgba(244, 63, 94, 0.3);">
    <div class="max-w-2xl w-full">
        <div class="glass-card p-8 text-center text-white">
            <h1 class="text-3xl font-bold mb-6"><i class="bi bi-shield-fill-exclamation"></i> Finding Safe Space</h1>
            <div class="breathing-circle mx-auto mb-8"></div>
            <p class="text-xl mb-8">Take a deep breath... Help is on the way</p>
            
            <div id="nearest-haven" class="card bg-white text-gray-900 dark:bg-gray-800 dark:text-white p-6 mb-6">
                <div class="animate-pulse">
                    <div class="h-6 bg-gray-300 rounded mb-3"></div>
                    <div class="h-4 bg-gray-300 rounded mb-2"></div>
                    <div class="h-10 bg-gray-300 rounded"></div>
                </div>
            </div>
            
            <div class="space-y-3 mb-6">
                <h4 class="font-semibold text-white text-lg">Alternative Options:</h4>
                <div id="alternative-havens" class="text-left space-y-2">
                    <div class="animate-pulse p-3 bg-white bg-opacity-20 rounded-lg h-12"></div>
                    <div class="animate-pulse p-3 bg-white bg-opacity-20 rounded-lg h-12"></div>
                </div>
            </div>
            
            <div class="space-y-3">
                <button id="call-emergency" class="btn bg-white text-rose-600 hover:bg-gray-100 w-full flex items-center justify-center gap-2">
                    <i class="bi bi-telephone-fill"></i>
                    Call Emergency Contact
                </button>
                <div class="p-4 bg-white bg-opacity-20 rounded-lg text-sm">
                    <p class="font-semibold mb-1">Crisis Text Line</p>
                    <p>Text HOME to 741741</p>
                </div>
                <a href="tel:988" class="btn bg-yellow-500 text-gray-900 hover:bg-yellow-400 w-full flex items-center justify-center gap-2">
                    <i class="bi bi-telephone-fill"></i>
                    988 Suicide & Crisis Lifeline
                </a>
            </div>
            
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline text-white border-white hover:bg-white hover:text-rose-600 w-full mt-6">
                I'm Feeling Better
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let userLocation = null;
    
    async function loadNearestHaven() {
        try {
            const position = await NeuroNav.getCurrentLocation();
            userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
        } catch (error) {
            userLocation = { lat: 40.7128, lng: -74.0060 };
        }
        
        try {
            const havens = await NeuroNav.fetchAPI(`/api/nearby-havens?lat=${userLocation.lat}&lng=${userLocation.lng}`);
            
            if (havens.length > 0) {
                const nearest = havens[0];
                document.getElementById('nearest-haven').innerHTML = `
                    <h3 class="text-xl font-bold mb-3 flex items-center justify-center gap-2">
                        <i class="bi ${getHavenIcon(nearest.type)} text-green-500"></i> 
                        Nearest Safe Haven
                    </h3>
                    <p class="text-2xl font-semibold mb-2">${nearest.name}</p>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">
                        ${nearest.distance.toFixed(1)} mi away (${Math.round(nearest.distance * 20)} min walk) â€¢ 
                        Calm Score: ${nearest.calm_score.toFixed(1)}
                    </p>
                    <a href="${nearest.maps_url}" target="_blank" class="btn btn-primary w-full text-lg">
                        <i class="bi bi-navigation-fill"></i>
                        START GUIDANCE NOW
                    </a>
                `;
                
                // Alternative havens
                const alternatives = havens.slice(1, 3);
                document.getElementById('alternative-havens').innerHTML = alternatives.map(h => `
                    <a href="${h.maps_url}" target="_blank" class="flex justify-between items-center p-3 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition">
                        <span><i class="bi ${getHavenIcon(h.type)}"></i> ${h.name}</span>
                        <span class="text-sm">${h.distance.toFixed(1)} mi</span>
                    </a>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading havens:', error);
        }
    }
    
    function getHavenIcon(type) {
        return { park: 'bi-tree-fill', library: 'bi-book-fill', cafe: 'bi-cup-hot-fill', museum: 'bi-building-fill' }[type] || 'bi-geo-fill';
    }
    
    document.getElementById('call-emergency').addEventListener('click', () => {
        const contacts = JSON.parse(localStorage.getItem('emergency_contacts') || '[]');
        if (contacts.length > 0) {
            if (confirm(`Call ${contacts[0].name} at ${contacts[0].phone}?`)) {
                window.location.href = `tel:${contacts[0].phone}`;
            }
        } else {
            NeuroNav.showToast('No emergency contacts set. Add one in Profile settings.', 'warning');
        }
    });
    
    document.addEventListener('DOMContentLoaded', loadNearestHaven);
</script>
{% endblock %}
